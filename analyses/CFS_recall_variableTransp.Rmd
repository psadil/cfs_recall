---
title: "CFS Recall (Master's Expt 2), Variable Opacity"
author: "pss"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  data_dir: data_variableTransp
  expt: CFSgonogo
  cutoff: 1
  percentiles: 5
  exclude: !r c(NA)
  low_name: !r c(28, 30, 45)
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.path = paste0(file.path('output','figures',params$expt),.Platform$file.sep), cache = FALSE, message = FALSE, fig.width = 14, fig.asp = 1)

library(tidyverse)
library(magrittr)
library(stringdist)
library(Hmisc)
library(ggridges)

source(file.path('utils.R'))
targets <- read_csv('objectNames_2afc.csv') 

out <- list()
for (i in 1:dim(targets[1])){
  out[i] = list(c(targets[i,]$name1, targets[i,]$name2, targets[i,]$name3, targets[i,]$name4, targets[i,]$name5, targets[i,]$name6, targets[i,]$name7, targets[i,]$name8, targets[i,]$name9, targets[i,]$name10, targets[i,]$name11, targets[i,]$name12, targets[i,]$name13, targets[i,]$name14, targets[i,]$name15))
}

cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

Conditions = c('Not Studied','CFS, Image', 'Binocular, Image')

colmap <- c('Not Studied'=cbPalette[7]
            ,'Word'=cbPalette[2]
            ,'CFS'=cbPalette[3]
            ,'Binocular'=cbPalette[4])

old_theme <- theme_set(theme_classic(base_size = 12)) +
  theme_update(
    axis.ticks = element_blank()
    , axis.line = element_line(size=1)
    , plot.margin=margin(rep(0,4))
  )

```


```{r loadData, message=FALSE}

s_dirs <- list.files(path=params$data_dir)
files <- list.files(path=file.path(params$data_dir, s_dirs, params$expt), pattern = ".csv", full.names = TRUE)
files <- files[!grepl(glue::glue('subject_{params$exclude}_'), files)]
d <- lapply(files, read_csv, col_types=cols(pas_1=col_character(),pas_2=col_character(), pas = col_character())) %>% 
  bind_rows() %>%
  select(subject, pas_1, pas_2, item_test, tType_study, item, name_test, gonogo_answer, response_cue, response_noise, rt_noise) %>%
  group_by(subject) %>%
  nest() %>%
  mutate(data = map(data, . %>% mutate(test_in_study = match(item_test, item)))) %>%
  mutate(data = map(data, . %>% mutate(Condition = tType_study[test_in_study]))) %>%
  unnest() %>%
  mutate(Condition = factor(Condition, levels = c("Not Studied","CFS","Binocular"))) %>%
  select(-item, -tType_study, -test_in_study) %>%
  mutate(noise_correct = if_else((gonogo_answer=='go' & response_noise=='Return') |
                                   (gonogo_answer=='nogo' & response_noise!='Return'), 1, 0)) %>%
  mutate(subject=factor(subject)) %>%
  mutate(targets = out[item_test]) %>%
  mutate(firstTarget=sapply(X=targets, FUN=function(x) extract2(x,1))) %>%
  mutate(dl = Map(function(x,y) stringdist(x, y, method="dl"), targets, response_cue)) %>%
  mutate(minDist = sapply(X=dl, FUN=function(x) min(x, na.rm=TRUE))) %>%
  mutate(cue_correct = if_else(minDist < params$cutoff, 1, 0)) %>%
  # rename(Condition = tType_test) %>%
  # mutate(Condition = factor(Condition, levels = c("Not Studied","CFS","Binocular"))) %>%
  mutate(pas_1 = as.numeric(substring(pas_1,1,1))) %>%
  mutate(pas_1 = if_else(is.na(pas_1),0,pas_1)) %>%
  mutate(pas_1 = factor(pas_1)) %>%
  mutate(pas_2 = as.numeric(substring(pas_2,1,1))) %>%
  mutate(pas_2 = if_else(is.na(pas_2),0,pas_2)) %>%
  mutate(pas_2 = factor(pas_2)) %>%
  mutate(id = 1:n()) %>%
  mutate(cue_correct_fct = factor(cue_correct))

  

# This method relies on saving the data and looking at each response to each cue individually. A response may have been marked as incorrect automatically, but could still be semantically related to the target. Those need to be corrected manually, and then the targets need to be updated.

# d %>%
#   mutate(id = 1:n()) %>%
#   select(firstTarget, response_cue, minDist, cue_correct, id) %>%
#   filter(cue_correct == 0) %>%
#   write_csv(x=., path = file.path("tmp.csv"))

```


```{r pas2}

# d %>%
#   filter(Condition=="CFS") %>%
#   ggplot(aes(x = pas_2)) +
#   geom_bar() +
#   # stat_summary(fun.data="mean_cl_boot") +
#   # scale_y_continuous(limits = c(0,1), name = "pas_2") +
#   # ggsave('pas.png') +
#   facet_grid(subject~.) +
#   # ggsave('pas_sub.png')


``` 



## Figures

The following plot shows the proportion of items that participants named correctly. The first plot shows each participant invididually to see which ones didn't try during the naming condition. These ones were excluded from the group-level plot and all further plots.

Note that in this group-level plot (and all other following), each participants' average performance is calculated separetely and then averaged together. Error bars reflect the bootstrapped 95% CI of the averaging across participant averages.

The three participants that appear not to have tried to name any objects (28, 30, 45), are excluded from all further figures


```{r naming}

d %>%
  ggplot(aes(x=Condition, y=cue_correct, color = Condition)) +
  stat_summary(fun.data="mean_cl_boot") +
  scale_color_manual(values=colmap, name= "Condition") +  
  facet_wrap(~subject, nrow = 3) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = .3, linetype = "dashed") +
  scale_y_continuous(limits = c(0,1), breaks = c(0,.5,1), name = "Naming Accuracy") +
  scale_x_discrete(name = NULL, label = element_blank()) 
# +
#   ggsave('name_accuracy_sub.png', height = params$fig_size[2], width = params$fig_size[1])

d %<>% filter(!(subject %in% params$low_name)) %>% mutate(subject = forcats::fct_drop(subject))

d %>%
  group_by(subject, Condition) %>%
  summarise(cue_correct = mean(cue_correct)) %>%
  ggplot(aes(x=Condition, y=cue_correct, color = Condition)) +
  stat_summary(fun.data="mean_cl_boot") +
  scale_y_continuous(limits = c(0,1), name = "Naming Accuracy") +
  scale_x_discrete(name = NULL, label = element_blank()) +
  scale_color_manual(values=colmap, name= "Condition") +
  geom_hline(yintercept = .3, linetype = "dashed")
# +
#   ggsave('name_accuracy_group.png')



```


The following plot shows proportion correct on the no/no-go trials (whether participants either said an item was appearing, or correctly waited). Raw accuracy is high. I didn't calculate anything like d' given that performance was basically at ceiling for all participants, and so d' would be infinity.

```{r noise_correct}

d %>%
  group_by(subject, Condition) %>%
  summarise(noise_correct = mean(noise_correct)) %>%
  ggplot(aes(x=Condition, y=noise_correct, color = Condition)) +
  stat_summary(fun.data="mean_cl_boot") +
  scale_y_continuous(limits = c(0,1), name = "Go/No-Go Accuracy") +
  scale_x_discrete(name = NULL, label = element_blank()) +
  scale_color_manual(values=colmap, name= "Condition") 
# +
#   ggsave('noise_accuracy_group.png')

d %>%
  ggplot(aes(x=Condition, y=noise_correct, color = Condition)) +
  stat_summary(fun.data="mean_cl_boot") +
  scale_x_discrete(name = NULL, label = element_blank()) +
  scale_color_manual(values=colmap, name= "Condition") +
  facet_wrap(~subject, nrow = 3) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_y_continuous(limits = c(0,1), breaks = c(0,.5,1), name = "Naming Accuracy") 
# +
#   ggsave('noise_accuracy_sub.png', height = params$fig_size[2], width = params$fig_size[1]) 

```


Percentiles are first calculated within participants, then averaged across participants. Points correspond to the .2, .4, .6, .8, and 1 quintiles. 

Note that because these lines are conditioned on accurately naming the cue item, there are different numbers of trial in each condition. 

```{r percentiles}

# p <- seq(from=.2, to=1, length.out = 5)

p <- seq(from=.2, to=1, length.out = 5)

tmp <- d %>%
  filter(gonogo_answer == "go" 
         & noise_correct==1)

# d[rep(seq(from=1, to=dim(d)[1]),times=length(p)),] %>%
#   filter(gonogo_answer == "go" 
#          & noise_correct==1) %>%
#   mutate(Percentile = rep(p, each=dim(tmp)[1])) %>%
#   group_by(Condition, Percentile, cue_correct_fct) %>%
#   summarise(RT = quantile(rt_noise, mean(Percentile), na.rm=TRUE)) %>%
#   # mutate(Percentile = factor(Percentile)) %>%
#   ggplot(aes(x=RT, y=Percentile, color=Condition, linetype = cue_correct_fct)) +
#   geom(fun.data = 'mean_cl_boot') +
#   geom_line() +
#   scale_y_continuous(limits = c(0,1), breaks = p, name = "CDF") +
#   scale_x_continuous(limits = c(0,4.5), name = "RT on (Correct) go trials") +
#   scale_color_manual(values=colmap, name= "Condition") 
# +
#   ggsave('noise_percentiles_group.png') 


d[rep(seq(from=1, to=dim(d)[1]),times=length(p)),] %>%
  filter(gonogo_answer == "go" 
         & noise_correct==1) %>%
  select(rt_noise, Condition, cue_correct_fct, subject) %>%
  mutate(Percentile = rep(p, each=dim(tmp)[1])) %>%
  group_by(Condition, Percentile, cue_correct_fct, subject) %>%
  summarise(RT = quantile(rt_noise, mean(Percentile), na.rm=TRUE)) %>%
  ggplot(aes(x=Percentile, y=RT, color=Condition, linetype = cue_correct_fct)) +
  stat_summary(fun.data = 'mean_cl_boot') +
  stat_summary(fun.y = 'mean', geom="line") +
  scale_x_continuous(limits = c(0,1), breaks = p, name = "Percentile") +
  scale_y_continuous(limits = c(0,4.5), name = "RT on (Correct) go trials") +
  scale_color_manual(values=colmap, name= "Condition") 
# +
#   ggsave('noise_percentilesT_group.png') 


```

These cdf plots are shown for each participant, once with Percentile on the x-axis and once with the axes swapped

```{r percentiles_sub}

d[rep(seq(from=1, to=dim(d)[1]),times=length(p)),] %>%
  filter(gonogo_answer == "go" 
         & noise_correct == 1) %>%
  mutate(Percentile = rep(p, each=dim(tmp)[1])) %>%
  group_by(Condition, Percentile, subject, cue_correct_fct) %>%
  summarise(RT = quantile(rt_noise, mean(Percentile), na.rm=TRUE)) %>%
  ggplot(aes(x=RT, y=Percentile, color=Condition, linetype=cue_correct_fct)) +
  geom_line() +
  scale_y_continuous(limits = c(0,1), breaks = p, name = "CDF") +
  scale_x_continuous(limits = c(0,4.5), name = "RT on (Correct) go trials") +
  scale_color_manual(values=colmap, name= "Condition") +
  facet_wrap(~subject, nrow=10) 
# +
#   ggsave('noise_percentiles_sub.png', height = params$fig_size[2], width = params$fig_size[1]) 


d[rep(seq(from=1, to = dim(d)[1]),times=length(p)),] %>%
  filter(gonogo_answer == "go" 
         & noise_correct == 1) %>%
  select(rt_noise, Condition, subject, cue_correct_fct) %>%
  mutate(Percentile = rep(p, each=dim(tmp)[1])) %>%
  group_by(Condition, Percentile, subject, cue_correct_fct) %>%
  summarise(RT = quantile(rt_noise, mean(Percentile), na.rm=TRUE)) %>%
  ggplot(aes(x=Percentile, y=RT, color=Condition, linetype=cue_correct_fct)) +
  geom_line() +
  scale_x_continuous(limits = c(0,1), breaks = p[seq.int(from=1,to=length(p), length.out = 3)], name = "CDF") +
  scale_y_continuous(limits = c(0,4.5), name = "RT on (Correct) go trials") +
  scale_color_manual(values=colmap, name= "Condition")+
  facet_wrap(~subject, nrow=3) 
# +
#   ggsave('noise_percentilesT_sub.png', height = params$fig_size[2], width = params$fig_size[1])


```

Here is a bit more detail about each participant's reaction time.

```{r rt_distributions}

d[rep(seq(from=1, to=dim(d)[1]),times=length(p)),] %>%
  filter(gonogo_answer == "go" 
         & noise_correct == 1) %>%
  ggplot(aes(x = rt_noise, y=Condition, fill = Condition, height = ..density.., alpha = cue_correct_fct)) +
  scale_alpha_discrete(range = c(.75, .25)) +
  geom_density_ridges(stat = "density") +
  scale_x_continuous(limits = c(0,4.5), name = "RT on (Correct) go", expand = c(0, 0)) +
  scale_y_discrete(name = NULL, label = element_blank(), expand = c(0.01, 0)) +
  scale_color_manual(values=colmap, name= "Condition") +
  theme(panel.grid.major.x = element_line(color = "gray", size = .5),
        panel.grid.minor.x = element_line(color = "gray", size = .5))
# +
#   ggsave('noise_violin_group.png') 
```

```{r rt_distributions_sub}

d[rep(seq(from=1, to=dim(d)[1]),times=length(p)),] %>%
  filter(gonogo_answer == "go" 
         & noise_correct==1) %>%
  ggplot(aes(x = rt_noise, y=Condition, fill = Condition, height = ..density.., alpha = cue_correct_fct)) +
  geom_density_ridges(stat = "density") +
  scale_alpha_discrete(range = c(.75, .25)) +
  scale_x_continuous(limits = c(0,4.5), name = "RT on (Correct) go trials", expand = c(0, 0)) +
  scale_y_discrete(name = NULL, label = element_blank(), expand = c(0.01, 0)) +
  scale_color_manual(values=colmap, name= "Condition") +
  facet_wrap(~subject, nrow = 10) +
  theme(panel.grid.major.x = element_line(color = "gray", size = .5),
        panel.grid.minor.x = element_line(color = "gray", size = .5))
# +
#   ggsave('noise_violin_noname_sub.png', height = params$fig_size[2], width = params$fig_size[1]) 


```

Finally, here are the empirical cdfs. In these plots, there is no collapsing across quintiles. The RTs are just ordered. Here, it's a little easier to see where an effect might be emerging in the data. 


```{r ecdf}


# d %>%
#   filter(gonogo_answer == "go" 
#          & noise_correct==1) %>%
#   ggplot(aes(x=rt_noise, color=Condition, linetype = cue_correct_fct)) +
#   scale_y_continuous(limits = c(0,1), name = "eCDF") +
#   scale_x_continuous(name = "RT on (Correct) go trials") +
#   scale_color_manual(values=colmap, name= "Condition") +
#   stat_ecdf() +
#   theme(panel.grid.major.x = element_line(color = "gray", size = .5))
# +
#   ggsave('noise_ecdf_group.png')

d %>%
  filter(gonogo_answer == "go" 
         & noise_correct==1) %>%
  group_by(Condition, subject, cue_correct_fct) %>%
  ggplot(aes(x=rt_noise, color=Condition, linetype = cue_correct_fct)) +
  scale_y_continuous(limits = c(0,1), name = "eCDF") +
  scale_x_continuous(name = "RT on (Correct) go trials") +
  scale_color_manual(values=colmap, name= "Condition") +
  stat_ecdf() +
  theme(panel.grid.major.x = element_line(color = "gray", size = .5))


d %>%
  filter(gonogo_answer == "go" 
         & noise_correct==1) %>%
  ggplot(aes(x=rt_noise, color=Condition, linetype = cue_correct_fct)) +
  scale_x_continuous(name = "RT on (Correct) go trials") +
  scale_color_manual(values=colmap, name= "Condition") +
  stat_ecdf() +
  facet_wrap(~subject, nrow = 10) +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = .5, linetype = "dashed") +
  scale_y_continuous(limits = c(0,1), breaks = c(0,.5,1), name = "eCDF") +
  theme(panel.grid.major.x = element_line(color = "gray", size = .5))
# +
#   ggsave('noise_ecdf_sub.png', height = params$fig_size[2], width = params$fig_size[1])
  


```
